<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦ä»·æ ¼è¶‹åŠ¿é¢„æµ‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/price_prediction.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="prediction-container">
        <h1>ğŸ“ˆ å›¾ä¹¦ä»·æ ¼è¶‹åŠ¿åˆ†æ</h1>

        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="search-box">
            <form id="prediction-form">
                <div class="form-group">
                    <label for="book-isbn">ISBNç¼–å·ï¼š</label>
                    <input type="text" id="book-isbn" placeholder="è¯·è¾“å…¥13ä½ISBNç¼–å·" required>
                </div>
                <div class="form-group">
                    <label for="time-range">é¢„æµ‹å‘¨æœŸï¼š</label>
                    <select id="time-range">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="30" selected>æœ€è¿‘30å¤©</option>
                        <option value="90">æœ€è¿‘3ä¸ªæœˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="platform">æ¯”ä»·å¹³å°ï¼š</label>
                    <select id="platform" multiple>
                        <option value="jd" selected>äº¬ä¸œ</option>
                        <option value="dangdang">å½“å½“</option>
                        <option value="amazon">äºšé©¬é€Š</option>
                    </select>
                </div>
                <button type="submit" class="predict-btn">å¼€å§‹é¢„æµ‹</button>
            </form>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div class="result-area">
            <div class="statistics-area">
                <h2>ğŸ“Š å½“å‰ä¹¦ç±ä»·æ ¼åˆ†å¸ƒ</h2>
                <canvas id="bookStatChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <h3>å½“å‰ä»·æ ¼</h3>
                    <p id="current-price">--</p>
                    <div id="platform-prices" class="platform-prices">
                        <!-- æ¯”ä»·å¹³å°ä»·æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="stat-card">
                    <h3>é¢„æµ‹è¶‹åŠ¿</h3>
                    <p id="trend-indicator">--</p>
                </div>
                <div class="stat-card">
                    <h3>å»ºè®®æ“ä½œ</h3>
                    <p id="suggestion">--</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('prediction-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const isbn = document.getElementById('book-isbn').value;
            const days = document.getElementById('time-range').value;

            axios.post('/api/price/predict', {
                isbn: isbn,
                days: days
            }).then(response => {
                renderChart(response.data.history, response.data.prediction);
                updateStats(response.data);
            }).catch(error => {
                console.error('é¢„æµ‹å¤±è´¥:', error);
                alert('é¢„æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ISBNç¼–å·æ˜¯å¦æ­£ç¡®');
            });
        });

        function renderChart(historyData, predictionData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...historyData.dates, ...predictionData.dates],
                    datasets: [
                        {
                            label: 'å†å²ä»·æ ¼',
                            data: historyData.prices,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'é¢„æµ‹ä»·æ ¼',
                            data: [...Array(historyData.prices.length).fill(null), ...predictionData.prices],
                            borderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ä»·æ ¼è¶‹åŠ¿åˆ†æ'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: Â¥${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateStats(data) {
            document.getElementById('current-price').textContent = `Â¥${data.current_price.toFixed(2)}`;

            const trendElement = document.getElementById('trend-indicator');
            trendElement.textContent = data.trend === 'up' ? 'â†‘ ä¸Šæ¶¨' : data.trend === 'down' ? 'â†“ ä¸‹è·Œ' : 'â†’ å¹³ç¨³';
            trendElement.className = data.trend === 'up' ? 'up-trend' : data.trend === 'down' ? 'down-trend' : 'neutral-trend';

            document.getElementById('suggestion').textContent = data.suggestion;

            // æ›´æ–°æ¯”ä»·ä¿¡æ¯
            const platformPrices = document.getElementById('platform-prices');
            platformPrices.innerHTML = '';
            if (data.platform_prices) {
                Object.entries(data.platform_prices).forEach(([platform, price]) => {
                    const platformElement = document.createElement('div');
                    platformElement.className = 'platform-price';
                    platformElement.innerHTML = `
                        <span class="platform-name">${platform}</span>
                        <span class="platform-value">Â¥${price.toFixed(2)}</span>
                    `;
                    platformPrices.appendChild(platformElement);
                });
            }
        }
    </script>
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            axios.get('/api/books/statistics')
                .then(response => {
                    const data = response.data;
                    const ctx = document.getElementById('bookStatChart').getContext('2d');
    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['ä½äºÂ¥20', 'Â¥20-Â¥50', 'é«˜äºÂ¥50'],
                            datasets: [{
                                label: 'ä¹¦ç±æ•°é‡',
                                data: [data.below_20, data.between_20_50, data.above_50],
                                backgroundColor: ['#4caf50', '#2196f3', '#f44336']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `ğŸ“˜ ä¹¦ç±æ€»æ•°ï¼š${data.total_books} ï½œ å¹³å‡å”®ä»·ï¼šÂ¥${data.avg_price}`
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                });
        });
    </script>
    
    {% endblock %}
</body>
</html>
